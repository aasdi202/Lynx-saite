<!DOCTYPE html><html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>چت غیرمتمرکز LYNX</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
  <script type="module">
    import { Client } from "https://unpkg.com/@xmtp/xmtp-js?module";let signer, provider, xmtp, conversation;

async function initXMTP() {
  provider = new ethers.BrowserProvider(window.ethereum);
  signer = await provider.getSigner();
  xmtp = await Client.create(signer, { env: "dev" });
}

async function startChat() {
  const peerAddress = document.getElementById("peerAddress").value;
  conversation = await xmtp.conversations.newConversation(peerAddress);
  document.getElementById("chatSection").style.display = 'block';
  document.getElementById("startSection").style.display = 'none';
  loadMessages();
}

async function loadMessages() {
  const container = document.getElementById("messages");
  container.innerHTML = "در حال دریافت پیام‌ها...";
  const messages = await conversation.messages();
  container.innerHTML = "";
  for (const msg of messages) {
    const div = document.createElement("div");
    div.className = msg.senderAddress === conversation.clientAddress ? 'me' : 'you';
    div.innerText = msg.content;
    container.appendChild(div);
  }
  container.scrollTop = container.scrollHeight;
}

async function sendMessage() {
  const input = document.getElementById("messageInput");
  await conversation.send(input.value);
  input.value = "";
  loadMessages();
}

window.addEventListener('load', initXMTP);
window.startChat = startChat;
window.sendMessage = sendMessage;

  </script>
  <style>
    body {
      font-family: sans-serif;
      background: #e5e5e5;
      margin: 0;
    }
    header {
      background: #3b82f6;
      color: white;
      padding: 10px 20px;
      font-size: 1.2em;
      text-align: center;
    }
    #startSection, #chatSection {
      padding: 20px;
    }
    input[type=text] {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    #messages {
      height: 400px;
      overflow-y: scroll;
      background: white;
      padding: 10px;
      border-radius: 12px;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .me {
      align-self: flex-end;
      background: #3b82f6;
      color: white;
      padding: 8px 12px;
      border-radius: 15px 15px 0 15px;
      max-width: 70%;
    }
    .you {
      align-self: flex-start;
      background: #ddd;
      padding: 8px 12px;
      border-radius: 15px 15px 15px 0;
      max-width: 70%;
    }
    button {
      padding: 10px 20px;
      border: none;
      background: #10b981;
      color: white;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>پیام‌رسان غیرمتمرکز LYNX</header>  <div id="startSection">
    <input type="text" id="peerAddress" placeholder="آدرس کیف پول مخاطب" />
    <button onclick="startChat()">شروع چت</button>
  </div>  <div id="chatSection" style="display:none">
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="پیام خود را بنویسید..." onkeydown="if(event.key==='Enter') sendMessage()" />
    <button onclick="sendMessage()">ارسال</button>
  </div>
</body>
</html>
